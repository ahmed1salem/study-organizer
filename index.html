<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÖŸèŸÜÿ∏ŸêŸëŸÖ ÿßŸÑŸÖÿ∞ÿßŸÉÿ±ÿ© ÿßŸÑÿ∞ŸÉŸä</title>
    <!-- Font: Tajawal -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <!-- Library to render AI response formatting -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --primary-color: #4a90e2; --primary-dark: #357abd; --secondary-color: #f5f7fa;
            --font-color: #333; --border-color: #e0e0e0; --card-bg: rgba(255, 255, 255, 0.9); /* Semi-transparent card */
            --shadow: 0 4px 12px rgba(0,0,0,0.08); --success-color: #28a745;
            --danger-color: #dc3545; --warning-color: #ffc107; --info-color: #17a2b8;
        }
        body { 
            font-family: 'Tajawal', sans-serif; 
            margin: 0; 
            /* New Background with Logo */
            background-image: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhm8BTEMhjCqdzP6dIcFY8oWy5-hH8sAsoZh1OVFhlpFQ5j1D6W5GgvNpy8DSLB1xuMrkeiE_NVQU7MUVQuNJuIT-l4Ubu2RtfjCjc-NNymW2yasYR7TV8ql8y1dUwGRDTcjoc5VuT8sMA5JVqCk8sS8BlbthtIEIGECEGs3s3myOS3PAvV2UctFEfst8E/s1000/Digital%20Minds%20Logo%20No%20bg.png');
            background-size: contain;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-color: #f8f9fa;
            color: var(--font-color); 
            line-height: 1.7; 
            padding-bottom: 50px; /* Space for the footer */
        }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        header { text-align: center; margin-bottom: 40px; padding: 20px; background-color: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); position: relative; backdrop-filter: blur(5px); }
        header h1 { color: var(--primary-color); font-size: 2.5em; margin: 0; font-weight: 700; }
        .main-grid { display: grid; grid-template-columns: 300px 1fr; gap: 30px; align-items: start; }
        .card { 
            background-color: var(--card-bg); 
            border-radius: 12px; 
            padding: 25px; 
            box-shadow: var(--shadow); 
            border: 1px solid var(--border-color);
            /* Glassmorphism effect */
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .card h2, .card h3 { margin-top: 0; color: var(--primary-dark); border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; margin-bottom: 20px; font-weight: 700; }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; box-sizing: border-box; }
        button { background-color: var(--primary-color); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 700; width: 100%; transition: background-color 0.3s; }
        button:hover { background-color: var(--primary-dark); }
        #subjects-list { list-style-type: none; padding: 0; max-height: 400px; overflow-y: auto; }
        #subjects-list li { padding: 15px; background-color: var(--secondary-color); margin-bottom: 10px; border-radius: 8px; cursor: pointer; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        #subjects-list li.active, #subjects-list li:hover { background-color: var(--primary-color); color: white; }
        .priority-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
        .priority-High { background-color: var(--danger-color); }
        .priority-Medium { background-color: var(--warning-color); }
        .priority-Low { background-color: var(--success-color); }
        .loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7); z-index: 1001; }
        .loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 12px; text-align: center; }
        #login-section { max-width: 400px; margin: 50px auto; }
        #app-section { display: none; }
        #logout-btn { background-color: var(--danger-color); width: auto; padding: 8px 20px; font-size: 0.9em; }
        #welcome-message { float: left; margin-top: 10px; font-weight: bold; }
        .close-button { color: #aaa; float: left; font-size: 28px; font-weight: bold; cursor: pointer; }
        
        /* --- AI Assistant Styles --- */
        #ai-fab { position: fixed; bottom: 80px; right: 30px; width: 60px; height: 60px; background: linear-gradient(45deg, var(--info-color), var(--primary-color)); color: white; border-radius: 50%; border: none; font-size: 2em; text-align: center; line-height: 60px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 999; transition: transform 0.3s ease; }
        #ai-fab:hover { transform: scale(1.1); }
        #ai-modal .modal-content { max-width: 600px; height: 70vh; display: flex; flex-direction: column; padding: 0; text-align: right; }
        #ai-modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        #ai-modal-header h3 { margin: 0; border: none; padding: 0; }
        #new-chat-btn { width: auto; font-size: 0.8em; padding: 5px 15px; background-color: var(--success-color); }
        #ai-chat-history { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .chat-bubble { padding: 10px 15px; border-radius: 20px; max-width: 80%; word-wrap: break-word; }
        .user-bubble { background-color: var(--primary-color); color: white; border-bottom-right-radius: 5px; align-self: flex-start; }
        .ai-bubble { background-color: #e9e9eb; color: var(--font-color); border-bottom-left-radius: 5px; align-self: flex-end; }
        .ai-bubble p:last-child, .ai-bubble ul:last-child { margin-bottom: 0; }
        #ai-input-container { padding: 15px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; }
        #ai-input-container input { flex-grow: 1; margin-bottom: 0; }
        #ai-input-container button { width: auto; border-radius: 8px; }
        .typing-indicator { align-self: flex-end; }
        .typing-indicator span { height: 8px; width: 8px; margin: 0 2px; background-color: #999; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        .flashcard-status, .resource-item { font-size: 0.8em; padding: 3px 8px; border-radius: 12px; color: white; }
        .resource-item { background: #fafafa; color: var(--font-color); padding: 15px; margin-bottom: 10px; }
        .resource-item a { color: var(--primary-color); font-weight: bold; text-decoration: none; }
        
        /* --- New Footer Style --- */
        .site-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding: 10px 0;
            font-size: 0.9em;
            z-index: 1000;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        @media (max-width: 768px) {
            .main-grid { grid-template-columns: 1fr; }
            .container { padding: 0 10px; }
            header h1 { font-size: 1.8em; }
            .card { padding: 15px; }
            #welcome-message { display: none; }
            #ai-modal .modal-content { width: 100%; height: 100%; max-width: 100%; margin: 0; border-radius: 0; }
            .site-footer { font-size: 0.8em; }
            #ai-fab { bottom: 60px; } /* Move FAB up to not overlap with footer */
        }
    </style>
</head>
<body>

    <div class="loader-overlay" id="loader"></div>

    <div id="login-section" class="container"></div>

    <div id="app-section" class="container">
        <header>
            <div style="overflow: hidden;">
                <span id="welcome-message"></span>
                <button id="logout-btn" onclick="logout()" style="float: right;">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</button>
            </div>
            <h1>üéì ŸÖŸèŸÜÿ∏ŸêŸëŸÖ ÿßŸÑŸÖÿ∞ÿßŸÉÿ±ÿ© ÿßŸÑÿ∞ŸÉŸä</h1>
        </header>

        <div class="main-grid"></div>
        <div class="card" style="margin-top: 30px;"></div>
    </div>

    <button id="ai-fab" onclick="openAIModal()" title="ÿßŸÑŸÖÿ≥ÿßÿπÿØ ÿßŸÑÿ∞ŸÉŸä">ü§ñ</button>

    <div id="ai-modal" class="modal"></div>
    <div id="quiz-modal" class="modal"></div>

    <!-- New Footer -->
    <footer class="site-footer">
        ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿπŸÇŸàŸÑ ÿßŸÑÿ±ŸÇŸÖŸäÿ© ÿ®ŸÇŸäÿßÿØÿ© ÿ£ÿ≠ŸÖÿØ ÿ≥ÿßŸÑŸÖ
    </footer>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxRcYjGGXob_7laRhC1Y8lRPmhiosJoSsw8QKD9tJYGhwmphJPWGz6pyiHzkl2hi3oLJw/exec";

        let currentUserId, currentUsername, currentSubjectId, currentSubjectName;
        let subjectData = [], flashcardData = [];

        const loader = document.getElementById('loader');
        const showLoader = () => loader.style.display = 'block';
        const hideLoader = () => loader.style.display = 'none';

        async function callAppsScript(funcName, args = [], showGlobalLoader = true) {
            if (showGlobalLoader) showLoader();
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'cors', redirect: 'follow',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify({ action: funcName, params: args })
                });
                if (!res.ok) throw new Error(`Network error: ${res.status}`);
                const response = await res.json();
                if (response.status === 'error') {
                    console.error("Error from backend:", response);
                    throw new Error(response.message);
                }
                return response.data;
            } catch (error) {
                alert(`ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ${error.message}. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿµÿ≠ÿ© ŸÖŸÅÿ™ÿßÿ≠ API ŸÅŸä ŸÉŸàÿØ Apps Script.`);
                return null;
            } finally {
                if (showGlobalLoader) hideLoader();
            }
        }

        function openAIModal() { document.getElementById('ai-modal').style.display = 'block'; }
        function closeAIModal() { document.getElementById('ai-modal').style.display = 'none'; }
        
        function newAIChat() {
            const chatHistory = document.getElementById('ai-chat-history');
            chatHistory.innerHTML = ''; // Clear history
            const welcomeBubble = document.createElement('div');
            welcomeBubble.className = 'chat-bubble ai-bubble';
            welcomeBubble.textContent = 'ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ! ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ŸÅŸä ŸÖÿ∞ÿßŸÉÿ±ÿ™ŸÉ ÿßŸÑŸäŸàŸÖÿü';
            chatHistory.appendChild(welcomeBubble);
        }

        async function askAI() {
            const promptInput = document.getElementById('ai-prompt');
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            const chatHistory = document.getElementById('ai-chat-history');

            const userBubble = document.createElement('div');
            userBubble.className = 'chat-bubble user-bubble';
            userBubble.textContent = prompt;
            chatHistory.appendChild(userBubble);
            
            promptInput.value = '';
            chatHistory.scrollTop = chatHistory.scrollHeight;

            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-bubble typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            chatHistory.appendChild(typingIndicator);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            const result = await callAppsScript('callGeminiAI', [prompt], false);
            
            chatHistory.removeChild(typingIndicator);

            const aiBubble = document.createElement('div');
            aiBubble.className = 'chat-bubble ai-bubble';
            if (result) {
                aiBubble.innerHTML = marked.parse(result);
            } else {
                aiBubble.textContent = "ÿπÿ∞ÿ±ÿßŸãÿå ŸÑŸÖ ÿ£ÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ•ÿ¨ÿßÿ®ÿ©. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.";
            }
            chatHistory.appendChild(aiBubble);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function renderInitialUI() {
            document.getElementById('login-section').innerHTML = `
                <div class="card">
                    <h2 style="text-align: center;">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</h2>
                    <p id="login-error" style="color: red; text-align: center;"></p>
                    <input type="text" id="username-input" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©)">
                    <input type="password" id="password-input" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±">
                    <button onclick="login()">ÿØÿÆŸàŸÑ</button>
                </div>`;
            
            const appSection = document.getElementById('app-section');
            appSection.querySelector('.main-grid').innerHTML = `
                <div class="card">
                    <h2>ÿßŸÑŸÖŸàÿßÿØ ÿßŸÑÿØÿ±ÿßÿ≥Ÿäÿ©</h2>
                    <div id="add-subject-form">
                        <input type="text" id="subject-name-input" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿßÿØÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©">
                        <select id="subject-priority-select">
                            <option value="High">ÿ£ŸàŸÑŸàŸäÿ© ÿπÿßŸÑŸäÿ©</option>
                            <option value="Medium" selected>ÿ£ŸàŸÑŸàŸäÿ© ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©</option>
                            <option value="Low">ÿ£ŸàŸÑŸàŸäÿ© ŸÖŸÜÿÆŸÅÿ∂ÿ©</option>
                        </select>
                        <button onclick="addSubject()">ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿßÿØÿ©</button>
                    </div>
                    <ul id="subjects-list" style="margin-top: 20px;"></ul>
                </div>
                <div id="main-content" style="display: none;">
                    <div class="card">
                        <h2 id="current-subject-title">ÿßÿÆÿ™ÿ± ŸÖÿßÿØÿ© ŸÑŸÑÿ®ÿØÿ°</h2>
                        <div id="resource-library">
                            <h3>üìö ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑŸÖŸàÿßÿ±ÿØ</h3>
                            <div id="resources-list"></div>
                            <h4>ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿ±ÿØ ÿ¨ÿØŸäÿØ:</h4>
                            <input type="text" id="resource-title-input" placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖŸàÿ±ÿØ">
                            <select id="resource-type-select">
                                <option value="youtube">ÿ±ÿßÿ®ÿ∑ ŸäŸàÿ™ŸäŸàÿ®</option>
                                <option value="link">ÿ±ÿßÿ®ÿ∑ ŸÖŸàŸÇÿπ/ŸÖŸÑŸÅ</option>
                                <option value="note">ŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸÜÿµŸäÿ©</option>
                            </select>
                            <textarea id="resource-content-input" placeholder="ÿ∂ÿπ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸáŸÜÿß ÿ£Ÿà ÿßŸÉÿ™ÿ® ŸÖŸÑÿßÿ≠ÿ∏ÿ™ŸÉ" rows="3"></textarea>
                            <button onclick="addResource()">ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸàÿ±ÿØ</button>
                        </div>
                        <hr style="margin: 40px 0; border: 1px solid var(--border-color);">
                        <div id="flashcard-maker">
                            <h3>üÉè ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑÿ™ÿπŸÑŸäŸÖŸäÿ© <button id="start-quiz-btn" class="success" style="display: inline-block; width: auto; float: left; padding: 8px 15px; font-size: 0.8em;" onclick="startQuiz()">ÿ®ÿØÿ° ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ∞ŸÉŸä</button></h3>
                            <div id="flashcards-list"></div>
                            <h4>ÿ•ŸÜÿ¥ÿßÿ° ÿ®ÿ∑ÿßŸÇÿ© ÿ¨ÿØŸäÿØÿ©:</h4>
                            <input type="text" id="flashcard-question-input" placeholder="ÿßŸÉÿ™ÿ® ÿßŸÑÿ≥ÿ§ÿßŸÑ ŸáŸÜÿß">
                            <textarea id="flashcard-answer-input" placeholder="ÿßŸÉÿ™ÿ® ÿßŸÑÿ¨Ÿàÿßÿ® ŸáŸÜÿß" rows="2"></textarea>
                            <button onclick="addFlashcard()">ÿ•ÿ∂ÿßŸÅÿ© ÿ®ÿ∑ÿßŸÇÿ©</button>
                        </div>
                    </div>
                </div>`;
            
            appSection.querySelector('.card[style*="margin-top"]').innerHTML = `
                <h2>üìÖ ŸÖŸàŸÑÿØ ÿßŸÑÿÆÿ∑ÿ© ÿßŸÑÿØÿ±ÿßÿ≥Ÿäÿ© ŸÅÿßÿ¶ŸÇ ÿßŸÑÿ∞ŸÉÿßÿ°</h2>
                <p>ŸäŸÇŸàŸÖ ÿ®ÿ•ŸÜÿ¥ÿßÿ° ÿÆÿ∑ÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑŸÖŸàÿßÿØ Ÿàÿ¢ÿÆÿ± ŸÖÿ±ÿ© ÿ™ŸÖÿ™ ŸÖÿ±ÿßÿ¨ÿπÿ™Ÿáÿß.</p>
                <button onclick="generateSmartStudyPlan()" class="success" style="margin-top: 10px;">ÿ™ŸàŸÑŸäÿØ ÿÆÿ∑ÿ© ÿ∞ŸÉŸäÿ©</button>
                <div id="study-plan-output" style="margin-top: 20px; background: #e9f5e9; padding: 15px; border-radius: 8px;"></div>`;
            
            document.getElementById('ai-modal').innerHTML = `
                <div class="modal-content">
                    <div id="ai-modal-header">
                        <span class="close-button" onclick="closeAIModal()">&times;</span>
                        <h3>ü§ñ ÿßŸÑŸÖÿ≥ÿßÿπÿØ ÿßŸÑÿ∞ŸÉŸä</h3>
                        <button id="new-chat-btn" onclick="newAIChat()">ÿ¥ÿßÿ™ ÿ¨ÿØŸäÿØ</button>
                    </div>
                    <div id="ai-chat-history">
                        <div class="chat-bubble ai-bubble">ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ! ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ŸÅŸä ŸÖÿ∞ÿßŸÉÿ±ÿ™ŸÉ ÿßŸÑŸäŸàŸÖÿü</div>
                    </div>
                    <div id="ai-input-container">
                        <input type="text" id="ai-prompt" placeholder="ÿßŸÉÿ™ÿ® ÿ≥ÿ§ÿßŸÑŸÉ ŸáŸÜÿß..." onkeydown="if(event.key==='Enter') askAI()">
                        <button onclick="askAI()">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
                    </div>
                </div>`;
            
            document.getElementById('quiz-modal').innerHTML = `
                <div class="modal-content">
                    <span class="close-button" onclick="closeQuiz()">&times;</span>
                    <h3 id="quiz-subject-title">ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ∞ŸÉŸä</h3>
                    <div id="quiz-card" onclick="revealAnswer()">
                        <p id="quiz-question"></p>
                        <p id="quiz-answer" style="display:none;"></p>
                    </div>
                    <div class="quiz-controls" style="display:none;">
                        <button class="dont-know-btn" onclick="handleQuizResponse('Learning')">ŸÑÿß ÿ£ÿπÿ±ŸÅŸáÿß</button>
                        <button class="know-btn" onclick="handleQuizResponse('Mastered')">ÿ£ÿπÿ±ŸÅŸáÿß</button>
                    </div>
                </div>`;
        }

        async function login() {
            const username = document.getElementById('username-input').value.trim();
            const password = document.getElementById('password-input').value;
            if (!username || !password) return alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸàŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±.');
            const result = await callAppsScript('loginUser', [username, password]);
            if (result && result.userId) {
                currentUserId = result.userId;
                currentUsername = result.username;
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('app-section').style.display = 'block';
                document.getElementById('welcome-message').textContent = `ÿ£ŸáŸÑÿßŸã ÿ®ŸÉÿå ${currentUsername}`;
                loadSubjects();
            }
        }

        function logout() { window.location.reload(); }
        
        async function loadSubjects() {
            if (!currentUserId) return;
            subjectData = await callAppsScript('getSubjects', [currentUserId]) || [];
            const list = document.getElementById('subjects-list');
            list.innerHTML = '';
            subjectData.forEach(s => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${s.name}</span> <span class="priority-dot priority-${s.priority}" title="ÿ£ŸàŸÑŸàŸäÿ© ${s.priority}"></span>`;
                li.dataset.id = s.id;
                li.onclick = () => selectSubject(s.id, s.name);
                list.appendChild(li);
            });
        }
        
        async function addSubject() {
            if (!currentUserId) return;
            const name = document.getElementById('subject-name-input').value.trim();
            const priority = document.getElementById('subject-priority-select').value;
            if (!name) return alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿßÿØÿ©.');
            const newSubject = await callAppsScript('addSubject', [currentUserId, name, priority]);
            if (newSubject) {
                document.getElementById('subject-name-input').value = '';
                await loadSubjects();
                selectSubject(newSubject.id, newSubject.name);
            }
        }

        function selectSubject(id, name) {
            currentSubjectId = id;
            currentSubjectName = name;
            document.getElementById('current-subject-title').textContent = `ŸÖÿ≠ÿ™ŸàŸâ ŸÖÿßÿØÿ©: ${name}`;
            document.getElementById('main-content').style.display = 'block';
            document.querySelectorAll('#subjects-list li').forEach(li => li.classList.toggle('active', li.dataset.id === id));
            loadResources();
            loadFlashcards();
        }

        async function loadResources() {
            if (!currentUserId || !currentSubjectId) return;
            const resources = await callAppsScript('getResources', [currentUserId, currentSubjectId]);
            const list = document.getElementById('resources-list');
            list.innerHTML = '';
            if (resources && resources.length > 0) {
                resources.forEach(res => {
                    const div = document.createElement('div');
                    div.className = 'resource-item';
                    let contentHTML = `<strong>${res.title} (${res.type === 'youtube' ? 'ŸäŸàÿ™ŸäŸàÿ®' : (res.type === 'link' ? 'ÿ±ÿßÿ®ÿ∑' : 'ŸÖŸÑÿßÿ≠ÿ∏ÿ©')}):</strong>`;
                    if (res.type === 'note') {
                        contentHTML += `<p style="margin-top: 5px;">${res.content.replace(/\n/g, '<br>')}</p>`;
                    } else {
                        contentHTML += ` <a href="${res.content}" target="_blank">ŸÅÿ™ÿ≠ ÿßŸÑŸÖÿµÿØÿ±</a>`;
                    }
                    div.innerHTML = contentHTML;
                    list.appendChild(div);
                });
            } else {
                list.innerHTML = '<p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸàÿßÿ±ÿØ ŸÑŸáÿ∞Ÿá ÿßŸÑŸÖÿßÿØÿ© ÿ®ÿπÿØ.</p>';
            }
        }

        async function addResource() {
            if (!currentUserId || !currentSubjectId) return alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖÿßÿØÿ© ÿ£ŸàŸÑÿßŸã.');
            const title = document.getElementById('resource-title-input').value.trim();
            const type = document.getElementById('resource-type-select').value;
            const content = document.getElementById('resource-content-input').value.trim();
            if (!title || !content) return alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖŸàÿ±ÿØ.');
            const newResource = await callAppsScript('addResource', [currentUserId, currentSubjectId, type, content, title]);
            if (newResource) {
                document.getElementById('resource-title-input').value = '';
                document.getElementById('resource-content-input').value = '';
                loadResources();
            }
        }

        async function loadFlashcards() {
            if (!currentUserId || !currentSubjectId) return;
            flashcardData = await callAppsScript('getFlashcards', [currentUserId, currentSubjectId]) || [];
            const list = document.getElementById('flashcards-list');
            list.innerHTML = '';
            if (flashcardData.length > 0) {
                flashcardData.forEach(card => {
                    const div = document.createElement('div');
                    div.className = 'flashcard-item';
                    div.innerHTML = `<p><strong>ÿ≥:</strong> ${card.question}</p><p><strong>ÿ¨:</strong> ${card.answer}</p>
                                     <span class="flashcard-status status-${card.status}">${card.status}</span>`;
                    list.appendChild(div);
                });
            } else {
                list.innerHTML = '<p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ÿ∑ÿßŸÇÿßÿ™ ŸÖÿ±ÿßÿ¨ÿπÿ© ŸÑŸáÿ∞Ÿá ÿßŸÑŸÖÿßÿØÿ© ÿ®ÿπÿØ.</p>';
            }
        }

        async function addFlashcard() {
             if (!currentUserId || !currentSubjectId) return;
             const question = document.getElementById('flashcard-question-input').value.trim();
             const answer = document.getElementById('flashcard-answer-input').value.trim();
             if (!question || !answer) return;
             await callAppsScript('addFlashcard', [currentUserId, currentSubjectId, question, answer]);
             document.getElementById('flashcard-question-input').value = '';
             document.getElementById('flashcard-answer-input').value = '';
             loadFlashcards();
        }

        async function generateSmartStudyPlan() {
            if (subjectData.length === 0) return alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿßÿØ ÿ£ŸàŸÑÿßŸã.');
            const priorityValues = { 'High': 3, 'Medium': 2, 'Low': 1 };
            const now = new Date();
            const scoredSubjects = subjectData.map(s => {
                const daysSinceStudied = s.lastStudied ? (now - new Date(s.lastStudied)) / (1000 * 3600 * 24) : 999;
                const score = priorityValues[s.priority] * 2 + daysSinceStudied;
                return { ...s, score };
            }).sort((a, b) => b.score - a.score);
            const days = ["ÿßŸÑÿ≥ÿ®ÿ™", "ÿßŸÑÿ£ÿ≠ÿØ", "ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ", "ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°", "ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°", "ÿßŸÑÿÆŸÖŸäÿ≥", "ÿßŸÑÿ¨ŸÖÿπÿ©"];
            let planHTML = '<h4>üóìÔ∏è ÿÆÿ∑ÿ™ŸÉ ÿßŸÑÿ∞ŸÉŸäÿ© ÿßŸÑŸÖŸÇÿ™ÿ±ÿ≠ÿ©:</h4><ul>';
            for (let i = 0; i < days.length; i++) {
                const subjectForToday = scoredSubjects[i % scoredSubjects.length];
                planHTML += `<li><strong>${days[i]}:</strong> ŸÖÿ∞ÿßŸÉÿ±ÿ© ŸÖÿßÿØÿ© "${subjectForToday.name}"</li>`;
                callAppsScript('updateLastStudied', [currentUserId, subjectForToday.id]);
            }
            planHTML += '</ul><p>ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ™Ÿàÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©. ÿ®ÿßŸÑÿ™ŸàŸÅŸäŸÇ!</p>';
            document.getElementById('study-plan-output').innerHTML = planHTML;
            setTimeout(loadSubjects, 1000);
        }

        let quizFlashcards = [], currentCardIndex = 0;
        function startQuiz() {
            if (flashcardData.length === 0) return alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ÿ∑ÿßŸÇÿßÿ™ ŸÑÿ®ÿØÿ° ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±.');
            const learning = flashcardData.filter(c => c.status !== 'Mastered');
            const mastered = flashcardData.filter(c => c.status === 'Mastered');
            quizFlashcards = [...learning, ...mastered.slice(0, 3)].sort(() => Math.random() - 0.5);
            if (quizFlashcards.length === 0) return alert('ÿ±ÿßÿ¶ÿπ! ŸÑŸÇÿØ ÿ£ÿ™ŸÇŸÜÿ™ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™.');
            currentCardIndex = 0;
            document.getElementById('quiz-modal').style.display = 'block';
            displayQuizCard();
        }
        function closeQuiz() { 
            document.getElementById('quiz-modal').style.display = 'none';
            loadFlashcards();
        }
        function displayQuizCard() {
            const card = quizFlashcards[currentCardIndex];
            const quizModal = document.getElementById('quiz-modal');
            quizModal.querySelector('#quiz-question').innerText = card.question;
            quizModal.querySelector('#quiz-answer').innerText = card.answer;
            quizModal.querySelector('#quiz-question').style.display = 'block';
            quizModal.querySelector('#quiz-answer').style.display = 'none';
            quizModal.querySelector('.quiz-controls').style.display = 'none';
        }
        function revealAnswer() {
            const quizModal = document.getElementById('quiz-modal');
            quizModal.querySelector('#quiz-question').style.display = 'none';
            quizModal.querySelector('#quiz-answer').style.display = 'block';
            quizModal.querySelector('.quiz-controls').style.display = 'flex';
        }
        async function handleQuizResponse(status) {
            const card = quizFlashcards[currentCardIndex];
            await callAppsScript('updateFlashcardStatus', [currentUserId, card.id, status]);
            currentCardIndex++;
            if (currentCardIndex >= quizFlashcards.length) {
                alert('ŸÑŸÇÿØ ÿ£ŸÉŸÖŸÑÿ™ ÿ¨ŸàŸÑÿ© ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©!');
                closeQuiz();
                return;
            }
            displayQuizCard();
        }

        window.onload = () => {
            renderInitialUI();
            document.getElementById('app-section').style.display = 'none';
            document.getElementById('login-section').style.display = 'block';
        };
    </script>
</body>
</html>
