<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مُنظِّم المذاكرة الذكي</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4a90e2;
            --primary-dark: #357abd;
            --secondary-color: #f5f7fa;
            --font-color: #333;
            --border-color: #e0e0e0;
            --card-bg: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }
        body { font-family: 'Cairo', sans-serif; margin: 0; background-color: var(--secondary-color); color: var(--font-color); line-height: 1.6; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        header { text-align: center; margin-bottom: 40px; padding: 20px; background-color: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); }
        header h1 { color: var(--primary-color); font-size: 2.5em; margin: 0; }
        .main-grid { display: grid; grid-template-columns: 300px 1fr; gap: 30px; align-items: start; }
        .card { background-color: var(--card-bg); border-radius: 12px; padding: 25px; box-shadow: var(--shadow); }
        .card h2, .card h3 { margin-top: 0; color: var(--primary-dark); border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; margin-bottom: 20px; }
        input[type="text"], input[type="password"], input[type="url"], textarea, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; box-sizing: border-box; }
        button { background-color: var(--primary-color); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; width: 100%; }
        #subjects-list { list-style-type: none; padding: 0; max-height: 400px; overflow-y: auto; }
        #subjects-list li { padding: 15px; background-color: var(--secondary-color); margin-bottom: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        #subjects-list li.active, #subjects-list li:hover { background-color: var(--primary-color); color: white; }
        .priority-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
        .priority-High { background-color: var(--danger-color); }
        .priority-Medium { background-color: var(--warning-color); }
        .priority-Low { background-color: var(--success-color); }
        .loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7); z-index: 1001; }
        .loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 12px; text-align: center; }
        #login-section { max-width: 400px; margin: 50px auto; }
        #app-section { display: none; }
        #logout-btn { background-color: var(--danger-color); width: auto; padding: 8px 20px; font-size: 0.9em; }
        #welcome-message { float: left; }
    </style>
</head>
<body>

    <div class="loader-overlay" id="loader">
        <div class="loader"></div>
    </div>

    <!-- Login Section -->
    <div id="login-section" class="container">
        <div class="card">
            <h2 style="text-align: center;">تسجيل الدخول</h2>
            <p id="login-error" style="color: red; text-align: center;"></p>
            <input type="text" id="username-input" placeholder="اسم المستخدم (باللغة الإنجليزية)">
            <input type="password" id="password-input" placeholder="كلمة المرور">
            <button onclick="login()">دخول</button>
        </div>
    </div>

    <!-- Main App Section -->
    <div id="app-section" class="container">
        <header>
            <div style="overflow: hidden;">
                <span id="welcome-message"></span>
                <button id="logout-btn" onclick="logout()" style="float: right;">تسجيل الخروج</button>
            </div>
            <h1>🎓 مُنظِّم المذاكرة الذكي</h1>
        </header>

        <div class="main-grid">
            <div class="card">
                <h2>المواد الدراسية</h2>
                <div id="add-subject-form">
                    <input type="text" id="subject-name-input" placeholder="اسم المادة الجديدة">
                    <select id="subject-priority-select">
                        <option value="High">أولوية عالية</option>
                        <option value="Medium" selected>أولوية متوسطة</option>
                        <option value="Low">أولوية منخفضة</option>
                    </select>
                    <button onclick="addSubject()">إضافة مادة</button>
                </div>
                <ul id="subjects-list" style="margin-top: 20px;"></ul>
            </div>

            <div id="main-content" style="display: none;">
                <div class="card">
                    <h2 id="current-subject-title">اختر مادة للبدء</h2>
                    <!-- Resources and Flashcards sections remain the same -->
                </div>
            </div>
        </div>
        <!-- Study Plan section remains the same -->
    </div>

    <!-- Quiz Modal remains the same -->

    <script>
        // === JavaScript Logic (Multi-user Version) ===
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx4KqW5dabHzf-vUqesF5BUJfbhxrKaKjYxeR9ud4kBQrx1xInvk4p5bEzvi_15Tvmeiw/exec"; // !!! استبدل هذا بالرابط الجديد !!!

        let currentUserId = null;
        let currentUsername = null;
        // Other global variables...
        let currentSubjectId = null;
        let currentSubjectName = '';
        let subjectData = [];
        let flashcardData = [];

        const loader = document.getElementById('loader');
        function showLoader() { loader.style.display = 'block'; }
        function hideLoader() { loader.style.display = 'none'; }

        async function callAppsScript(funcName, args = []) {
            showLoader();
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'cors', redirect: 'follow',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify({ action: funcName, params: args })
                });
                if (!res.ok) throw new Error(`Network response was not ok: ${res.status}`);
                const responseData = await res.json();
                if (responseData.status === 'error') throw new Error(responseData.message);
                return responseData.data;
            } catch (error) {
                console.error('Error calling Apps Script:', error);
                alert(`حدث خطأ: ${error.message}.`);
                return null;
            } finally {
                hideLoader();
            }
        }

        // --- Authentication Logic ---
        async function login() {
            const username = document.getElementById('username-input').value.trim();
            const password = document.getElementById('password-input').value;
            const errorP = document.getElementById('login-error');
            errorP.textContent = '';

            if (!username || !password) {
                errorP.textContent = 'الرجاء إدخال اسم المستخدم وكلمة المرور.';
                return;
            }

            const result = await callAppsScript('loginUser', [username, password]);

            if (result && result.userId) {
                currentUserId = result.userId;
                currentUsername = result.username;

                document.getElementById('login-section').style.display = 'none';
                document.getElementById('app-section').style.display = 'block';
                document.getElementById('welcome-message').textContent = `أهلاً بك، ${currentUsername}`;
                
                loadSubjects();
            } else {
                 errorP.textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة.';
            }
        }

        function logout() {
            currentUserId = null;
            currentUsername = null;
            
            document.getElementById('app-section').style.display = 'none';
            document.getElementById('login-section').style.display = 'block';
            
            // Clear inputs
            document.getElementById('username-input').value = '';
            document.getElementById('password-input').value = '';
            document.getElementById('login-error').textContent = '';
            
            // Clear data displays
            document.getElementById('subjects-list').innerHTML = '';
            document.getElementById('main-content').style.display = 'none';
        }

        // --- Data Functions (Updated to use currentUserId) ---
        async function loadSubjects() {
            if (!currentUserId) return;
            // All data calls must now include currentUserId
            const subjects = await callAppsScript('getSubjects', [currentUserId]);
            if (subjects === null) return;
            
            subjectData = subjects;
            const subjectsList = document.getElementById('subjects-list');
            subjectsList.innerHTML = '';
            subjects.forEach(subject => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${subject.name}</span> <span class="priority-dot priority-${subject.priority}"></span>`;
                li.dataset.id = subject.id;
                li.onclick = () => selectSubject(subject.id, subject.name);
                subjectsList.appendChild(li);
            });
        }

        async function addSubject() {
            if (!currentUserId) return;
            const name = document.getElementById('subject-name-input').value.trim();
            const priority = document.getElementById('subject-priority-select').value;
            if (!name) return alert('الرجاء إدخال اسم المادة.');
            
            const newSubject = await callAppsScript('addSubject', [currentUserId, name, priority]);
            if (newSubject) {
                document.getElementById('subject-name-input').value = '';
                await loadSubjects();
                selectSubject(newSubject.id, newSubject.name);
            }
        }

        function selectSubject(id, name) {
            currentSubjectId = id;
            currentSubjectName = name;
            document.getElementById('current-subject-title').textContent = `محتوى مادة: ${name}`;
            document.getElementById('main-content').style.display = 'block';
            document.querySelectorAll('#subjects-list li').forEach(li => li.classList.toggle('active', li.dataset.id === id));
            loadResources();
            loadFlashcards();
        }

        async function loadResources() {
            if (!currentUserId || !currentSubjectId) return;
            const resources = await callAppsScript('getResources', [currentUserId, currentSubjectId]);
            // ... rendering logic is the same
        }

        async function addResource() {
            if (!currentUserId || !currentSubjectId) return alert('الرجاء اختيار مادة أولاً.');
            const title = document.getElementById('resource-title-input').value.trim();
            const type = document.getElementById('resource-type-select').value;
            const content = document.getElementById('resource-content-input').value.trim();
            if (!title || !content) return alert('الرجاء ملء جميع حقول المورد.');
            
            await callAppsScript('addResource', [currentUserId, currentSubjectId, type, content, title]);
            loadResources();
        }
        
        async function loadFlashcards() {
            if (!currentUserId || !currentSubjectId) return;
            flashcardData = await callAppsScript('getFlashcards', [currentUserId, currentSubjectId]) || [];
            // ... rendering logic is the same
        }

        async function addFlashcard() {
             if (!currentUserId || !currentSubjectId) return alert('الرجاء اختيار مادة أولاً.');
             const question = document.getElementById('flashcard-question-input').value.trim();
             const answer = document.getElementById('flashcard-answer-input').value.trim();
             if (!question || !answer) return alert('الرجاء ملء السؤال والجواب.');
             
             await callAppsScript('addFlashcard', [currentUserId, currentSubjectId, question, answer]);
             loadFlashcards();
        }

        // Other functions like generateSmartStudyPlan and Quiz logic remain largely the same
        // as they operate on the globally stored `subjectData` and `flashcardData`.

        // Initial state: Show login form
        window.onload = () => {
            document.getElementById('app-section').style.display = 'none';
            document.getElementById('login-section').style.display = 'block';
        };
    </script>
</body>
</html>
