<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مُنظِّم المذاكرة الذكي</title>
    
    <meta name="description" content="حوّل مذاكرتك مع مُنظِّم المذاكرة الذكي! أداة مجانية لتنظيم المواد الدراسية، إنشاء خطط ذكية أسبوعية، وصنع بطاقات تعليمية فعالة. احصل على نصائح شخصية من المساعد الذكي وتابع تقدمك بسهولة لتحقيق أفضل النتائج.">

    <link rel="icon" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEipSyzskLTjBJQ7eGegZ-UaWo9-z1NgpDByEcnYfkNibq_yV8vDdPJUlJ3376WSR0aqns6RQPZg-S9bOJOFhK7WGObfhd08Rbi-3MA8P2TcOA63Y3mOGQUBMkZx-RButZJH3ntSNZ97Q-fycfUsRNCy0JD5CMfie3oTmfemrGEnjMZG3Hk-9hoG94yIwEk/s500/Study%20organizer%20no%20bg.png" type="image/png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --primary-color: #4a90e2; --primary-dark: #357abd; --secondary-color: #f5f7fa;
            --font-color: #333; --border-color: #e0e0e0; --card-bg: rgba(255, 255, 255, 0.9);
            --shadow: 0 4px 12px rgba(0,0,0,0.08); --success-color: #28a745;
            --danger-color: #dc3545; --warning-color: #ffc107; --info-color: #17a2b8;
            --ai-bubble-bg: #e9e9eb;
        }
        .dark-mode {
            --secondary-color: #2c3e50; --font-color: #ecf0f1; --border-color: #34495e;
            --card-bg: rgba(44, 62, 80, 0.85);
            --ai-bubble-bg: #34495e;
        }
        body { 
            font-family: 'Tajawal', sans-serif; 
            margin: 0; 
            background-image: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhm8BTEMhjCqdzP6dIcFY8oWy5-hH8sAsoZh1OVFhlpFQ5j1D6W5GgvNpy8DSLB1xuMrkeiE_NVQU7MUVQuNJuIT-l4Ubu2RtfjCjc-NNymW2yasYR7TV8ql8y1dUwGRDTcjoc5VuT8sMA5JVqCk8sS8BlbthtIEIGECEGs3s3myOS3PAvV2UctFEfst8E/s1000/Digital%20Minds%20Logo%20No%20bg.png');
            background-size: contain;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-color: #f8f9fa;
            color: var(--font-color); 
            line-height: 1.7; 
            transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        header { 
            padding: 15px; 
            background-color: var(--card-bg); 
            border-radius: 12px; 
            box-shadow: var(--shadow); 
            backdrop-filter: blur(5px); 
            border: 1px solid rgba(255,255,255,0.5);
            margin-bottom: 40px;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-side {
            flex: 1;
            display: flex;
            align-items: center;
        }
        .header-side.right {
            justify-content: flex-end;
            gap: 15px;
        }
        .header-center {
            flex: 2;
            text-align: center;
        }
        header h1 { color: var(--primary-color); font-size: 2.5em; margin: 0; font-weight: 700; }
        .main-grid { display: grid; grid-template-columns: 300px 1fr; gap: 30px; align-items: start; }
        .card { 
            background-color: var(--card-bg); 
            border-radius: 12px; 
            padding: 25px; 
            box-shadow: var(--shadow); 
            border: 1px solid rgba(255,255,255,0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .card h2, .card h3 { margin-top: 0; color: var(--primary-dark); border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; margin-bottom: 20px; font-weight: 700; }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; box-sizing: border-box; background-color: var(--secondary-color); color: var(--font-color); }
        button { background-color: var(--primary-color); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 700; width: 100%; transition: all 0.3s ease; }
        button:hover { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        button:disabled { background-color: #999; cursor: not-allowed; transform: none; box-shadow: none; }
        #subjects-list { list-style-type: none; padding: 0; max-height: 400px; overflow-y: auto; }
        #subjects-list li { padding: 15px; background-color: var(--secondary-color); margin-bottom: 10px; border-radius: 8px; cursor: pointer; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        #subjects-list li.active, #subjects-list li:hover { background-color: var(--primary-color); color: white; }
        .priority-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
        .priority-High { background-color: var(--danger-color); }
        .priority-Medium { background-color: var(--warning-color); }
        .priority-Low { background-color: var(--success-color); }
        .loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7); z-index: 1001; }
        .loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: var(--card-bg); backdrop-filter: blur(5px); margin: 10% auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 12px; text-align: center; }
        #login-section, #signup-section { max-width: 400px; margin: 50px auto; }
        #app-section, #login-section, #signup-section, #landing-section { display: none; }
        #app-section { padding-bottom: 60px; }
        #logout-btn { background-color: var(--danger-color); width: auto; padding: 8px 20px; font-size: 0.9em; }
        #welcome-message { font-weight: bold; }
        .close-button { color: #aaa; float: left; font-size: 28px; font-weight: bold; cursor: pointer; }
        
        #ai-fab { position: fixed; bottom: 80px; right: 30px; width: 70px; height: 70px; background: #2596be; border-radius: 50%; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 999; transition: transform 0.3s ease; display: flex; justify-content: center; align-items: center; animation: pulse 2.5s infinite; font-size: 2.5em; line-height: 70px; }
        #ai-fab:hover { transform: scale(1.1); animation-play-state: paused; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(37, 150, 190, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(37, 150, 190, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 150, 190, 0); } }
        #ai-modal .modal-content { max-width: 600px; height: 70vh; display: flex; flex-direction: column; padding: 0; text-align: right; }
        #ai-modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        #ai-modal-header h3 { margin: 0; border: none; padding: 0; }
        #new-chat-btn { width: auto; font-size: 0.8em; padding: 5px 15px; background-color: var(--success-color); }
        #ai-chat-history { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .chat-bubble { padding: 10px 15px; border-radius: 20px; max-width: 80%; word-wrap: break-word; }
        .user-bubble { background-color: var(--primary-color); color: white; border-bottom-right-radius: 5px; align-self: flex-start; }
        .ai-bubble { background-color: var(--ai-bubble-bg); color: var(--font-color); border-bottom-left-radius: 5px; align-self: flex-end; }
        .ai-bubble p:last-child, .ai-bubble ul:last-child { margin-bottom: 0; }
        #ai-input-container { padding: 15px; border-top: 1px solid var(--border-color); }
        #ai-prompt-controls { display: flex; gap: 10px; margin-bottom: 10px; }
        #ai-prompt-controls input { flex-grow: 1; margin-bottom: 0; }
        #ai-prompt-controls button { width: auto; border-radius: 8px; }
        .typing-indicator { align-self: flex-end; }
        .typing-indicator span { height: 8px; width: 8px; margin: 0 2px; background-color: #999; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        .flashcard-status, .resource-item { font-size: 0.8em; padding: 3px 8px; border-radius: 12px; color: white; }
        .resource-item { background-color: var(--secondary-color); color: var(--font-color); padding: 15px; margin-bottom: 10px; position: relative; }
        .resource-item a { color: var(--primary-color); font-weight: bold; text-decoration: none; }
        .ai-tools { position: absolute; top: 10px; left: 10px; display: flex; gap: 5px; }
        .ai-tool-btn { font-size: 0.7em; padding: 4px 8px; width: auto; background-color: var(--info-color); }
        
        .site-footer {
            text-align: center;
            padding: 15px;
            background-color: #1c1c1c;
            color: #f0f0f0;
            font-size: 0.9em;
        }
        .dark-mode .site-footer {
            background-color: #000;
        }
        
        #landing-section { flex-direction: column; align-items: center; justify-content: flex-start; text-align: center; box-sizing: border-box; background-color: rgba(255, 255, 255, 0.5); backdrop-filter: blur(5px); }
        .hero { padding: 100px 20px; width: 100%; box-sizing: border-box; }
        .hero h1 { font-size: 3.5em; color: var(--primary-dark); margin-bottom: 20px; }
        .hero p { font-size: 1.2em; max-width: 700px; margin: 0 auto 40px auto; color: #555; }
        .landing-content { width: 100%; max-width: 1000px; padding: 40px 20px; box-sizing: border-box; }
        .section-title { font-size: 2.5em; color: var(--primary-dark); margin-bottom: 40px; }
        .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin-bottom: 40px; }
        .feature-card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.5); }
        .feature-card svg { width: 50px; height: 50px; stroke: var(--primary-color); margin-bottom: 15px; }
        .feature-card h3 { margin-bottom: 10px; color: var(--primary-dark); }
        .testimonial { background: var(--card-bg); padding: 30px; border-radius: 12px; margin: 60px 0; font-style: italic; }
        .testimonial p { font-size: 1.1em; }
        .testimonial cite { display: block; margin-top: 15px; font-weight: bold; }
        #start-btn, .cta-btn { padding: 15px 40px; font-size: 1.2em; width: auto; }
        
        #dark-mode-toggle { background: none; border: none; font-size: 1.5em; cursor: pointer; width: auto; padding: 0; }
        .points-display { font-weight: bold; color: var(--success-color); }
        .nav-link { cursor: pointer; text-decoration: underline; color: var(--primary-color); }
        .auth-toggle { text-align: center; margin-top: 15px; }

        @media (max-width: 768px) {
            .main-grid { grid-template-columns: 1fr; }
            .container { padding: 0 10px; }
            header h1 { font-size: 1.8em; }
            .header-content { flex-direction: column; gap: 10px; }
            .header-side.right { order: -1; }
            #landing-section h1, .hero h1 { font-size: 2.5em; }
            .card { padding: 15px; }
            #ai-modal .modal-content { width: 100%; height: 100%; max-width: 100%; margin: 0; border-radius: 0; }
            #ai-fab { bottom: 20px; right: 20px; width: 60px; height: 60px; font-size: 2em; line-height: 60px; }
        }
    </style>
</head>
<body>

    <div class="loader-overlay" id="loader"></div>

    <div id="landing-section"></div>
    <div id="login-section" class="container"></div>
    <div id="signup-section" class="container"></div>
    <div id="app-section" class="container"></div>
    <div id="ai-modal" class="modal"></div>
    <div id="quiz-modal" class="modal"></div>
    <div id="progress-modal" class="modal"></div>
    <div id="change-password-modal" class="modal"></div>
    <button id="ai-fab" onclick="openAIModal()" title="المساعد الذكي">🤖</button>
    <footer class="site-footer">
        جميع الحقوق محفوظة لفريق العقول الرقمية بقيادة أحمد سالم
    </footer>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyNu90ukmr4wXbAPEtgwDAoMHsx6eKJhRBrWZHvpB1tRSuPwDG2xFhWI1IUcKhybYbMjg/exec";

        let currentUserId, currentUsername, currentSubjectId, currentSubjectName;
        let subjectData = [], flashcardData = [], resourcesData = [];
        let tempGeneratedCards = null;

        const loader = document.getElementById('loader');
        const showLoader = () => loader.style.display = 'block';
        const hideLoader = () => loader.style.display = 'none';

        async function callAppsScript(funcName, args = [], showGlobalLoader = true) {
            if (showGlobalLoader) showLoader();
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'cors', redirect: 'follow',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify({ action: funcName, params: args })
                });
                if (!res.ok) throw new Error(`Network error: ${res.status}`);
                const response = await res.json();
                if (response.status === 'error') {
                    console.error("Error from backend:", response);
                    throw new Error(response.message);
                }
                return response.data;
            } catch (error) {
                alert(`حدث خطأ: ${error.message}. تأكد من صحة مفتاح API في كود Apps Script.`);
                return null;
            } finally {
                if (showGlobalLoader) hideLoader();
            }
        }
        
        const sections = ['landing-section', 'login-section', 'signup-section', 'app-section', 'progress-modal', 'change-password-modal'];
        const footer = document.querySelector('.site-footer');
        const aiFab = document.getElementById('ai-fab');

        function navigateTo(path) {
            window.location.hash = path;
        }

        function router() {
            const path = window.location.hash.slice(1) || 'home';
            
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });

            if (footer) footer.style.display = 'none';
            if (aiFab) aiFab.style.display = 'none';

            if (path === 'login') {
                document.getElementById('login-section').style.display = 'block';
            } else if (path === 'signup') {
                document.getElementById('signup-section').style.display = 'block';
            } else if (path === 'dashboard') {
                if (localStorage.getItem('userId')) {
                    currentUserId = localStorage.getItem('userId');
                    currentUsername = localStorage.getItem('username');
                    document.getElementById('app-section').style.display = 'block';
                    footer.style.display = 'block';
                    aiFab.style.display = 'flex';
                    const welcomeEl = document.getElementById('welcome-message');
                    if (welcomeEl && !welcomeEl.textContent) {
                        welcomeEl.innerHTML = `أهلاً بك، ${currentUsername} | <span class="points-display"></span> | <a class="nav-link" onclick="openChangePasswordModal()">تغيير كلمة المرور</a>`;
                        loadSubjects();
                        updateUserPointsDisplay();
                    }
                } else {
                    navigateTo('login');
                }
            } else if (path === 'progress') {
                 if (localStorage.getItem('userId')) {
                    document.getElementById('progress-modal').style.display = 'block';
                    showProgressPage();
                 } else {
                    navigateTo('login');
                 }
            } else {
                document.getElementById('landing-section').style.display = 'flex';
            }
        }

        window.addEventListener('hashchange', router);
        
        function openAIModal() { 
            document.getElementById('ai-modal').style.display = 'block';
            if(footer) footer.style.display = 'none';
        }
        function closeAIModal() { 
            document.getElementById('ai-modal').style.display = 'none';
            if (currentUserId && footer) footer.style.display = 'block';
        }
        
        function newAIChat() {
            const chatHistory = document.getElementById('ai-chat-history');
            chatHistory.innerHTML = '';
            const welcomeBubble = document.createElement('div');
            welcomeBubble.className = 'chat-bubble ai-bubble';
            welcomeBubble.textContent = 'أهلاً بك! كيف يمكنني مساعدتك في مذاكرتك اليوم؟';
            chatHistory.appendChild(welcomeBubble);
        }

        async function askAI() {
            const promptInput = document.getElementById('ai-prompt');
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            const isPersonalized = document.getElementById('personalize-toggle').checked;
            const chatHistory = document.getElementById('ai-chat-history');

            const userBubble = document.createElement('div');
            userBubble.className = 'chat-bubble user-bubble';
            userBubble.textContent = prompt;
            chatHistory.appendChild(userBubble);
            
            promptInput.value = '';
            chatHistory.scrollTop = chatHistory.scrollHeight;

            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-bubble typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            chatHistory.appendChild(typingIndicator);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            let result;
            if (isPersonalized) {
                result = await callAppsScript('callPersonalizedAI', [currentUserId, prompt], false);
            } else {
                result = await callAppsScript('callGeminiAI', [prompt], false);
            }
            
            chatHistory.removeChild(typingIndicator);

            const aiBubble = document.createElement('div');
            aiBubble.className = 'chat-bubble ai-bubble';
            if (result) {
                aiBubble.innerHTML = marked.parse(result);
            } else {
                aiBubble.textContent = "عذراً، لم أتمكن من الحصول على إجابة. حاول مرة أخرى.";
            }
            chatHistory.appendChild(aiBubble);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function renderInitialUI() {
            document.getElementById('landing-section').innerHTML = `
                <div class="hero">
                    <h1>حوّل مذاكرتك مع المساعد الذكي</h1>
                    <p>نظّم موادك، أنشئ خططًا ذكية، واختبر نفسك بفعالية. كل أدوات المذاكرة اللي تحتاجها في مكان واحد، مدعومة بالذكاء الاصطناعي لمساعدتك على تحقيق أفضل النتائج.</p>
                    <button id="start-btn" onclick="navigateTo('login')">ابدأ الآن مجاناً</button>
                </div>
                <div class="landing-content">
                    <h2 class="section-title">إزاي بيشتغل؟</h2>
                    <div class="features-grid">
                        <div class="feature-card"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg> <h3>1. أضف موادك</h3> <p>ابدأ بإضافة المواد الدراسية وحدد أولويتها عشان تركز على الأهم.</p> </div>
                        <div class="feature-card"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg> <h3>2. احصل على خطة</h3> <p>بضغطة زر، احصل على خطة مذاكرة أسبوعية ذكية بناءً على أولوياتك وآخر مراجعة.</p> </div>
                        <div class="feature-card"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8V8H6V12h2v4h8v-4h2V12h-2z"/><path d="M9 18v-2"/><path d="M15 18v-2"/></svg> <h3>3. ذاكر بذكاء</h3> <p>استخدم المساعد الذكي لشرح المفاهيم الصعبة وإنشاء بطاقات مراجعة تلقائيًا.</p> </div>
                    </div>
                    <div class="testimonial">
                        <p>"الموقع ده غير طريقة مذاكرتي تمامًا. الخطة الذكية والمساعد الشخصي ساعدوني أركز على الحاجات المهمة بجد."</p>
                        <cite>- طالب جامعي</cite>
                    </div>
                    <button class="cta-btn" onclick="navigateTo('login')">انضم الآن وابدأ المذاكرة بذكاء</button>
                </div>`;

            document.getElementById('login-section').innerHTML = `
                <div class="card">
                    <h2 style="text-align: center;">تسجيل الدخول</h2>
                    <p id="login-error" style="color: red; text-align: center;"></p>
                    <input type="text" id="username-input" placeholder="اسم المستخدم (باللغة الإنجليزية)">
                    <input type="password" id="password-input" placeholder="كلمة المرور">
                    <button onclick="login()">دخول</button>
                    <div class="auth-toggle"><a class="nav-link" onclick="navigateTo('signup')">ليس لديك حساب؟ أنشئ واحداً</a></div>
                </div>`;
            
            document.getElementById('signup-section').innerHTML = `
                <div class="card">
                    <h2 style="text-align: center;">إنشاء حساب جديد</h2>
                    <p id="signup-error" style="color: red; text-align: center;"></p>
                    <input type="text" id="signup-username" placeholder="اسم المستخدم (باللغة الإنجليزية)">
                    <input type="password" id="signup-password" placeholder="كلمة المرور">
                    <input type="password" id="signup-confirm-password" placeholder="تأكيد كلمة المرور">
                    <button onclick="register()">إنشاء حساب</button>
                    <div class="auth-toggle"><a class="nav-link" onclick="navigateTo('login')">لديك حساب بالفعل؟ سجل الدخول</a></div>
                </div>`;

            const appSection = document.getElementById('app-section');
            appSection.innerHTML = `
                <header>
                    <div class="header-content">
                        <div class="header-side">
                           <button id="dark-mode-toggle" onclick="toggleDarkMode()">☀️</button>
                        </div>
                        <div class="header-center">
                           <h1>🎓 مُنظِّم المذاكرة الذكي</h1>
                        </div>
                        <div class="header-side right">
                           <span id="welcome-message"></span>
                           <button id="logout-btn" onclick="logout()">تسجيل الخروج</button>
                        </div>
                    </div>
                </header>
                <div class="main-grid">
                    <div class="card">
                        <h2>المواد الدراسية</h2>
                        <div id="add-subject-form">
                            <input type="text" id="subject-name-input" placeholder="اسم المادة الجديدة">
                            <select id="subject-priority-select">
                                <option value="High">أولوية عالية</option>
                                <option value="Medium" selected>أولوية متوسطة</option>
                                <option value="Low">أولوية منخفضة</option>
                            </select>
                            <button onclick="addSubject()">إضافة مادة</button>
                        </div>
                        <ul id="subjects-list" style="margin-top: 20px;"></ul>
                        <a class="nav-link" onclick="navigateTo('progress')">عرض صفحة تقدمي</a>
                    </div>
                    <div id="main-content" style="display: none;">
                        <div class="card">
                            <h2 id="current-subject-title">اختر مادة للبدء</h2>
                            <div id="resource-library">
                                <h3>📚 مكتبة الموارد</h3>
                                <div id="resources-list"></div>
                                <h4>إضافة مورد جديد:</h4>
                                <input type="text" id="resource-title-input" placeholder="عنوان المورد">
                                <select id="resource-type-select">
                                    <option value="youtube">رابط يوتيوب</option>
                                    <option value="link">رابط موقع/ملف</option>
                                    <option value="note">ملاحظة نصية</option>
                                </select>
                                <textarea id="resource-content-input" placeholder="ضع الرابط هنا أو اكتب ملاحظتك" rows="3"></textarea>
                                <button onclick="addResource()">إضافة المورد</button>
                            </div>
                            <hr style="margin: 40px 0; border: 1px solid var(--border-color);">
                            <div id="flashcard-maker">
                                <h3>🃏 البطاقات التعليمية <button id="start-quiz-btn" class="success" style="display: inline-block; width: auto; float: left; padding: 8px 15px; font-size: 0.8em;" onclick="startQuiz()">بدء الاختبار الذكي</button></h3>
                                <div id="flashcards-list"></div>
                                <h4>إنشاء بطاقة جديدة:</h4>
                                <input type="text" id="flashcard-question-input" placeholder="اكتب السؤال هنا">
                                <textarea id="flashcard-answer-input" placeholder="اكتب الجواب هنا" rows="2"></textarea>
                                <button onclick="addFlashcard()">إضافة بطاقة</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card" style="margin-top: 30px;">
                    <h2>📅 مولد الخطة الدراسية فائق الذكاء</h2>
                    <p>يقوم بإنشاء خطة أسبوعية بناءً على أولوية المواد وآخر مرة تمت مراجعتها.</p>
                    <button onclick="generateSmartStudyPlan()" class="success" style="margin-top: 10px;">توليد خطة ذكية</button>
                    <div id="study-plan-output" style="margin-top: 20px;"></div>
                </div>`;
            
            document.getElementById('ai-modal').innerHTML = `
                <div class="modal-content">
                    <div id="ai-modal-header">
                        <span class="close-button" onclick="closeAIModal()">&times;</span>
                        <h3>🤖 المساعد الذكي</h3>
                        <button id="new-chat-btn" onclick="newAIChat()">شات جديد</button>
                    </div>
                    <div id="ai-chat-history">
                        <div class="chat-bubble ai-bubble">أهلاً بك! كيف يمكنني مساعدتك في مذاكرتك اليوم؟</div>
                    </div>
                    <div id="ai-input-container">
                        <div style="width: 100%; text-align: right; margin-bottom: 10px; font-size: 0.9em;">
                            <label>
                                <input type="checkbox" id="personalize-toggle">
                                تحليل بياناتي وتقديم نصيحة شخصية
                            </label>
                        </div>
                        <div id="ai-prompt-controls">
                            <input type="text" id="ai-prompt" placeholder="اكتب سؤالك هنا..." onkeydown="if(event.key==='Enter') askAI()">
                            <button onclick="askAI()">إرسال</button>
                        </div>
                    </div>
                </div>`;
            
            document.getElementById('quiz-modal').innerHTML = `
                <div class="modal-content">
                    <span class="close-button" onclick="closeQuiz()">&times;</span>
                    <h3 id="quiz-subject-title">الاختبار الذكي</h3>
                    <div id="quiz-card" onclick="revealAnswer()">
                        <p id="quiz-question"></p>
                        <p id="quiz-answer" style="display:none;"></p>
                    </div>
                    <div class="quiz-controls" style="display:none;">
                        <button class="dont-know-btn" onclick="handleQuizResponse('Learning', this)">لا أعرفها</button>
                        <button class="know-btn" onclick="handleQuizResponse('Mastered', this)">أعرفها</button>
                    </div>
                </div>`;
            
            document.getElementById('progress-modal').innerHTML = `
                <div class="modal-content">
                    <span class="close-button" onclick="navigateTo('dashboard')">&times;</span>
                    <h3>📊 صفحة تقدمي</h3>
                    <div id="stats-container"></div>
                </div>`;
            
            document.getElementById('change-password-modal').innerHTML = `
                <div class="modal-content">
                    <span class="close-button" onclick="closeChangePasswordModal()">&times;</span>
                    <h3>🔑 تغيير كلمة المرور</h3>
                    <p id="change-password-error" style="color: red;"></p>
                    <input type="password" id="old-password" placeholder="كلمة المرور القديمة">
                    <input type="password" id="new-password" placeholder="كلمة المرور الجديدة">
                    <input type="password" id="confirm-new-password" placeholder="تأكيد كلمة المرور الجديدة">
                    <button onclick="changePassword()">تغيير</button>
                </div>`;
        }

        async function login() {
            const username = document.getElementById('username-input').value.trim();
            const password = document.getElementById('password-input').value;
            if (!username || !password) return alert('الرجاء إدخال اسم المستخدم وكلمة المرور.');
            const result = await callAppsScript('loginUser', [username, password]);
            if (result && result.userId) {
                localStorage.setItem('userId', result.userId);
                localStorage.setItem('username', result.username);
                navigateTo('dashboard');
            }
        }

        async function register() {
            const username = document.getElementById('signup-username').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            const errorP = document.getElementById('signup-error');
            errorP.textContent = '';

            if (!username || !password) { return errorP.textContent = 'الرجاء ملء كل الحقول.'; }
            if (password !== confirmPassword) { return errorP.textContent = 'كلمتا المرور غير متطابقتين.'; }

            const result = await callAppsScript('registerUser', [username, password]);
            if (result && result.success) {
                alert(result.message);
                navigateTo('login');
            }
        }

        function openChangePasswordModal() { document.getElementById('change-password-modal').style.display = 'block'; }
        function closeChangePasswordModal() { document.getElementById('change-password-modal').style.display = 'none'; }

        async function changePassword() {
            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmNewPassword = document.getElementById('confirm-new-password').value;
            const errorP = document.getElementById('change-password-error');
            errorP.textContent = '';

            if (!oldPassword || !newPassword) { return errorP.textContent = 'الرجاء ملء كل الحقول.'; }
            if (newPassword !== confirmNewPassword) { return errorP.textContent = 'كلمتا المرور الجديدتان غير متطابقتين.'; }

            const result = await callAppsScript('changePassword', [currentUserId, oldPassword, newPassword]);
            if (result && result.success) {
                alert(result.message);
                closeChangePasswordModal();
            }
        }

        function logout() { 
            localStorage.removeItem('userId');
            localStorage.removeItem('username');
            currentUserId = null;
            currentUsername = null;
            navigateTo(''); 
        }
        
        async function loadSubjects() {
            if (!currentUserId) return;
            subjectData = await callAppsScript('getSubjects', [currentUserId]) || [];
            const list = document.getElementById('subjects-list');
            list.innerHTML = '';
            subjectData.forEach(s => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${s.name}</span> <span class="priority-dot priority-${s.priority}" title="أولوية ${s.priority}"></span>`;
                li.dataset.id = s.id;
                li.onclick = () => selectSubject(s.id, s.name);
                list.appendChild(li);
            });
        }
        
        async function addSubject() {
            if (!currentUserId) return;
            const name = document.getElementById('subject-name-input').value.trim();
            const priority = document.getElementById('subject-priority-select').value;
            if (!name) return alert('الرجاء إدخال اسم المادة.');
            const newSubject = await callAppsScript('addSubject', [currentUserId, name, priority]);
            if (newSubject) {
                document.getElementById('subject-name-input').value = '';
                await loadSubjects();
                selectSubject(newSubject.id, newSubject.name);
                updateUserPointsDisplay();
            }
        }

        function selectSubject(id, name) {
            currentSubjectId = id;
            currentSubjectName = name;
            document.getElementById('current-subject-title').textContent = `محتوى مادة: ${name}`;
            document.getElementById('main-content').style.display = 'block';
            document.querySelectorAll('#subjects-list li').forEach(li => li.classList.toggle('active', li.dataset.id === id));
            loadResources();
            loadFlashcards();
        }

        async function loadResources() {
            if (!currentUserId || !currentSubjectId) return;
            resourcesData = await callAppsScript('getResources', [currentUserId, currentSubjectId]) || [];
            const list = document.getElementById('resources-list');
            list.innerHTML = '';
            
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'ابحث في الموارد...';
            searchInput.onkeyup = () => filterResources(searchInput.value);
            list.appendChild(searchInput);

            const resourcesContainer = document.createElement('div');
            resourcesContainer.id = 'resources-container';
            list.appendChild(resourcesContainer);
            
            renderResources(resourcesData);
        }

        function renderResources(resources) {
            const container = document.getElementById('resources-container');
            container.innerHTML = '';
            if (resources && resources.length > 0) {
                resources.forEach(res => {
                    const div = document.createElement('div');
                    div.className = 'resource-item';
                    let contentHTML = `<strong>${res.title} (${res.type === 'youtube' ? 'يوتيوب' : (res.type === 'link' ? 'رابط' : 'ملاحظة')}):</strong>`;
                    if (res.type === 'note') {
                        contentHTML += `<p style="margin-top: 5px;">${res.content.replace(/\n/g, '<br>')}</p>`;
                        contentHTML += `<div class="ai-tools">
                            <button class="ai-tool-btn" onclick="summarizeNote('${res.id}')">لخصلي</button>
                            <button class="ai-tool-btn" onclick="generateFlashcards('${res.id}')">حوّل لبطاقات</button>
                        </div>`;
                    } else {
                        contentHTML += ` <a href="${res.content}" target="_blank">فتح المصدر</a>`;
                    }
                    div.innerHTML = contentHTML;
                    container.appendChild(div);
                });
            } else {
                container.innerHTML = '<p>لا توجد موارد لهذه المادة بعد.</p>';
            }
        }

        function filterResources(term) {
            const filtered = resourcesData.filter(r => 
                r.title.toLowerCase().includes(term.toLowerCase()) || 
                r.content.toLowerCase().includes(term.toLowerCase())
            );
            renderResources(filtered);
        }

        async function summarizeNote(resourceId) {
            const resource = resourcesData.find(r => r.id === resourceId);
            if (!resource) return;
            openAIModal();
            const chatHistory = document.getElementById('ai-chat-history');
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-bubble typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            chatHistory.appendChild(typingIndicator);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            const summary = await callAppsScript('summarizeText', [resource.content], false);
            
            chatHistory.removeChild(typingIndicator);
            const aiBubble = document.createElement('div');
            aiBubble.className = 'chat-bubble ai-bubble';
            if (summary) {
                aiBubble.innerHTML = `<h4>ملخص الملاحظة "${resource.title}":</h4>${marked.parse(summary)}`;
            } else {
                aiBubble.textContent = "عذراً، لم أتمكن من تلخيص النص.";
            }
            chatHistory.appendChild(aiBubble);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        async function generateFlashcards(resourceId) {
            const resource = resourcesData.find(r => r.id === resourceId);
            if (!resource) return;
            openAIModal();
            const chatHistory = document.getElementById('ai-chat-history');
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-bubble typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            chatHistory.appendChild(typingIndicator);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            const generatedCards = await callAppsScript('generateFlashcardsFromText', [resource.content], false);
            
            chatHistory.removeChild(typingIndicator);
            const aiBubble = document.createElement('div');
            aiBubble.className = 'chat-bubble ai-bubble';

            if (generatedCards && generatedCards.length > 0) {
                tempGeneratedCards = generatedCards;
                let cardsHtml = `<h4>تم إنشاء ${generatedCards.length} بطاقة من ملاحظة "${resource.title}":</h4><ul>`;
                generatedCards.forEach(c => {
                    cardsHtml += `<li><strong>س:</strong> ${c.question} <strong>ج:</strong> ${c.answer}</li>`;
                });
                cardsHtml += '</ul><button id="add-gen-cards-btn" class="ai-tool-btn" onclick="addGeneratedCards(this)">نعم، أضفهم للمادة</button>';
                aiBubble.innerHTML = cardsHtml;
            } else {
                aiBubble.textContent = "لم أتمكن من إنشاء بطاقات من هذا النص.";
            }
            chatHistory.appendChild(aiBubble);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        async function addGeneratedCards(button) {
            if (!tempGeneratedCards) return;
            
            button.disabled = true;
            button.textContent = 'جاري الإضافة...';

            const chatHistory = document.getElementById('ai-chat-history');
            const loadingBubble = document.createElement('div');
            loadingBubble.className = 'chat-bubble ai-bubble';
            loadingBubble.textContent = 'جاري حفظ البطاقات في قاعدة البيانات...';
            chatHistory.appendChild(loadingBubble);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            for (const card of tempGeneratedCards) {
                await callAppsScript('addFlashcard', [currentUserId, currentSubjectId, card.question, card.answer], false);
            }
            tempGeneratedCards = null;

            chatHistory.removeChild(loadingBubble);
            
            const confirmationBubble = document.createElement('div');
            confirmationBubble.className = 'chat-bubble ai-bubble';
            confirmationBubble.textContent = 'تمت إضافة البطاقات بنجاح!';
            chatHistory.appendChild(confirmationBubble);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            loadFlashcards();
            updateUserPointsDisplay();
        }

        async function addResource() {
            if (!currentUserId || !currentSubjectId) return alert('الرجاء اختيار مادة أولاً.');
            const title = document.getElementById('resource-title-input').value.trim();
            const type = document.getElementById('resource-type-select').value;
            const content = document.getElementById('resource-content-input').value.trim();
            if (!title || !content) return alert('الرجاء ملء جميع حقول المورد.');
            const newResource = await callAppsScript('addResource', [currentUserId, currentSubjectId, type, content, title]);
            if (newResource) {
                document.getElementById('resource-title-input').value = '';
                document.getElementById('resource-content-input').value = '';
                loadResources();
                updateUserPointsDisplay();
            }
        }

        async function loadFlashcards() {
            if (!currentUserId || !currentSubjectId) return;
            flashcardData = await callAppsScript('getFlashcards', [currentUserId, currentSubjectId]) || [];
            const list = document.getElementById('flashcards-list');
            list.innerHTML = '';
            
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'ابحث في البطاقات...';
            searchInput.onkeyup = () => filterFlashcards(searchInput.value);
            list.appendChild(searchInput);

            const flashcardsContainer = document.createElement('div');
            flashcardsContainer.id = 'flashcards-container';
            list.appendChild(flashcardsContainer);

            renderFlashcards(flashcardData);
        }

        function renderFlashcards(cards) {
            const container = document.getElementById('flashcards-container');
            container.innerHTML = '';
             if (cards && cards.length > 0) {
                cards.forEach(card => {
                    const div = document.createElement('div');
                    div.className = 'flashcard-item';
                    div.innerHTML = `<p><strong>س:</strong> ${card.question}</p><p><strong>ج:</strong> ${card.answer}</p>
                                     <span class="flashcard-status status-${card.status}">${card.status}</span>`;
                    container.appendChild(div);
                });
            } else {
                container.innerHTML = '<p>لا توجد بطاقات مراجعة لهذه المادة بعد.</p>';
            }
        }

        function filterFlashcards(term) {
             const filtered = flashcardData.filter(f => 
                f.question.toLowerCase().includes(term.toLowerCase()) || 
                f.answer.toLowerCase().includes(term.toLowerCase())
            );
            renderFlashcards(filtered);
        }

        async function addFlashcard() {
             if (!currentUserId || !currentSubjectId) return;
             const question = document.getElementById('flashcard-question-input').value.trim();
             const answer = document.getElementById('flashcard-answer-input').value.trim();
             if (!question || !answer) return;
             await callAppsScript('addFlashcard', [currentUserId, currentSubjectId, question, answer]);
             document.getElementById('flashcard-question-input').value = '';
             document.getElementById('flashcard-answer-input').value = '';
             loadFlashcards();
             updateUserPointsDisplay();
        }

        async function generateSmartStudyPlan() {
            if (subjectData.length === 0) return alert('الرجاء إضافة مواد أولاً.');
            const priorityValues = { 'High': 3, 'Medium': 2, 'Low': 1 };
            const now = new Date();
            const scoredSubjects = subjectData.map(s => {
                const daysSinceStudied = s.lastStudied ? (now - new Date(s.lastStudied)) / (1000 * 3600 * 24) : 999;
                const score = priorityValues[s.priority] * 2 + daysSinceStudied;
                return { ...s, score };
            }).sort((a, b) => b.score - a.score);
            const days = ["السبت", "الأحد", "الإثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"];
            let planHTML = '<h4>🗓️ خطتك الذكية المقترحة:</h4><ul>';
            for (let i = 0; i < days.length; i++) {
                const subjectForToday = scoredSubjects[i % scoredSubjects.length];
                planHTML += `<li><strong>${days[i]}:</strong> مذاكرة مادة "${subjectForToday.name}"</li>`;
                callAppsScript('updateLastStudied', [currentUserId, subjectForToday.id]);
            }
            planHTML += '</ul><p>تم تحديث تواريخ المراجعة. بالتوفيق!</p>';
            document.getElementById('study-plan-output').innerHTML = planHTML;
            setTimeout(loadSubjects, 1000);
        }

        let quizFlashcards = [], currentCardIndex = 0;
        function startQuiz() {
            if (flashcardData.length === 0) return alert('لا توجد بطاقات لبدء الاختبار.');
            const learning = flashcardData.filter(c => c.status !== 'Mastered');
            const mastered = flashcardData.filter(c => c.status === 'Mastered');
            quizFlashcards = [...learning, ...mastered.slice(0, 3)].sort(() => Math.random() - 0.5);
            if (quizFlashcards.length === 0) return alert('رائع! لقد أتقنت جميع البطاقات.');
            currentCardIndex = 0;
            document.getElementById('quiz-modal').style.display = 'block';
            displayQuizCard();
        }
        function closeQuiz() { 
            document.getElementById('quiz-modal').style.display = 'none';
            loadFlashcards();
        }
        function displayQuizCard() {
            const card = quizFlashcards[currentCardIndex];
            const quizModal = document.getElementById('quiz-modal');
            quizModal.querySelector('#quiz-question').innerText = card.question;
            quizModal.querySelector('#quiz-answer').innerText = card.answer;
            quizModal.querySelector('#quiz-question').style.display = 'block';
            quizModal.querySelector('#quiz-answer').style.display = 'none';
            quizModal.querySelector('.quiz-controls').style.display = 'none';
        }
        function revealAnswer() {
            const quizModal = document.getElementById('quiz-modal');
            quizModal.querySelector('#quiz-question').style.display = 'none';
            quizModal.querySelector('#quiz-answer').style.display = 'block';
            quizModal.querySelector('.quiz-controls').style.display = 'flex';
        }
        async function handleQuizResponse(status, button) {
            const controls = button.parentElement;
            controls.querySelectorAll('button').forEach(btn => btn.disabled = true);
            button.textContent = 'جاري...';

            const card = quizFlashcards[currentCardIndex];
            await callAppsScript('updateFlashcardStatus', [currentUserId, card.id, status], false);
            
            updateUserPointsDisplay();
            currentCardIndex++;

            controls.querySelectorAll('button').forEach(btn => btn.disabled = false);
            button.textContent = button.classList.contains('know-btn') ? 'أعرفها' : 'لا أعرفها';

            if (currentCardIndex >= quizFlashcards.length) {
                alert('لقد أكملت جولة المراجعة الحالية!');
                closeQuiz();
                return;
            }
            displayQuizCard();
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const toggle = document.getElementById('dark-mode-toggle');
            if (document.body.classList.contains('dark-mode')) {
                toggle.textContent = '🌙';
                localStorage.setItem('theme', 'dark');
            } else {
                toggle.textContent = '☀️';
                localStorage.setItem('theme', 'light');
            }
        }
        
        async function updateUserPointsDisplay() {
            const stats = await callAppsScript('getUserStats', [currentUserId], false);
            if (stats) {
                const pointsEl = document.querySelector('.points-display');
                if (pointsEl) pointsEl.textContent = `نقاطك: ${stats.points}`;
            }
        }
        
        async function showProgressPage() {
            const stats = await callAppsScript('getUserStats', [currentUserId]);
            if (stats) {
                const container = document.getElementById('stats-container');
                container.innerHTML = `
                    <p><strong>إجمالي المواد:</strong> ${stats.subjectCount}</p>
                    <p><strong>إجمالي الموارد:</strong> ${stats.resourceCount}</p>
                    <p><strong>إجمالي البطاقات:</strong> ${stats.flashcardCount}</p>
                    <p><strong>البطاقات المتقنة:</strong> ${stats.masteredFlashcards}</p>
                    <p class="points-display" style="font-size: 1.2em;"><strong>مجموع نقاطك:</strong> ${stats.points}</p>
                `;
            }
        }

        window.onload = () => {
            renderInitialUI();
            router();
            if (localStorage.getItem('theme') === 'dark') {
                toggleDarkMode();
            }
        };
    </script>
</body>
</html>
