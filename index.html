<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙÙ†Ø¸ÙÙ‘Ù… Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø°ÙƒÙŠ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4a90e2; --primary-dark: #357abd; --secondary-color: #f5f7fa;
            --font-color: #333; --border-color: #e0e0e0; --card-bg: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.08); --success-color: #28a745;
            --danger-color: #dc3545; --warning-color: #ffc107; --info-color: #17a2b8;
        }
        body { font-family: 'Cairo', sans-serif; margin: 0; background-color: var(--secondary-color); color: var(--font-color); line-height: 1.6; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        header { text-align: center; margin-bottom: 40px; padding: 20px; background-color: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); }
        header h1 { color: var(--primary-color); font-size: 2.5em; margin: 0; }
        .main-grid { display: grid; grid-template-columns: 300px 1fr; gap: 30px; align-items: start; }
        .card { background-color: var(--card-bg); border-radius: 12px; padding: 25px; box-shadow: var(--shadow); }
        .card h2, .card h3 { margin-top: 0; color: var(--primary-dark); border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; margin-bottom: 20px; }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; box-sizing: border-box; }
        button { background-color: var(--primary-color); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; width: 100%; }
        #subjects-list { list-style-type: none; padding: 0; max-height: 400px; overflow-y: auto; }
        #subjects-list li { padding: 15px; background-color: var(--secondary-color); margin-bottom: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        #subjects-list li.active, #subjects-list li:hover { background-color: var(--primary-color); color: white; }
        .priority-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
        .priority-High { background-color: var(--danger-color); }
        .priority-Medium { background-color: var(--warning-color); }
        .priority-Low { background-color: var(--success-color); }
        .loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7); z-index: 1001; }
        .loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 12px; text-align: center; }
        #login-section { max-width: 400px; margin: 50px auto; }
        #app-section { display: none; }
        #logout-btn { background-color: var(--danger-color); width: auto; padding: 8px 20px; font-size: 0.9em; }
        #welcome-message { float: left; margin-top: 10px; font-weight: bold; }
        .close-button { color: #aaa; float: left; font-size: 28px; font-weight: bold; cursor: pointer; }
        #quiz-card { min-height: 150px; display: flex; align-items: center; justify-content: center; font-size: 1.5em; cursor: pointer; border: 2px dashed var(--border-color); border-radius: 8px; padding: 20px; }
        #quiz-answer { display: none; }
        .quiz-controls { margin-top: 20px; display: flex; justify-content: center; gap: 15px; }
        .quiz-controls button { width: auto; }
        .quiz-controls .know-btn { background-color: var(--success-color); }
        .quiz-controls .dont-know-btn { background-color: var(--danger-color); }
        .flashcard-status { font-size: 0.8em; padding: 3px 8px; border-radius: 12px; color: white; }
        .status-New { background-color: var(--info-color); }
        .status-Learning { background-color: var(--warning-color); }
        .status-Mastered { background-color: var(--success-color); }
        @media (max-width: 768px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="loader-overlay" id="loader"></div>

    <div id="login-section" class="container">
        <div class="card">
            <h2 style="text-align: center;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <p id="login-error" style="color: red; text-align: center;"></p>
            <input type="text" id="username-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)">
            <input type="password" id="password-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="app-section" class="container">
        <header>
            <div style="overflow: hidden;">
                <span id="welcome-message"></span>
                <button id="logout-btn" onclick="logout()" style="float: right;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
            <h1>ğŸ“ Ù…ÙÙ†Ø¸ÙÙ‘Ù… Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø°ÙƒÙŠ</h1>
        </header>

        <div class="main-grid">
            <div class="card">
                <h2>Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h2>
                <div id="add-subject-form">
                    <input type="text" id="subject-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
                    <select id="subject-priority-select">
                        <option value="High">Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©</option>
                        <option value="Medium" selected>Ø£ÙˆÙ„ÙˆÙŠØ© Ù…ØªÙˆØ³Ø·Ø©</option>
                        <option value="Low">Ø£ÙˆÙ„ÙˆÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©</option>
                    </select>
                    <button onclick="addSubject()">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
                </div>
                <ul id="subjects-list" style="margin-top: 20px;"></ul>
            </div>

            <div id="main-content" style="display: none;">
                <div class="card">
                    <h2 id="current-subject-title">Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ù„Ù„Ø¨Ø¯Ø¡</h2>
                    <div id="resource-library"></div>
                    <hr style="margin: 40px 0; border: 1px solid var(--border-color);">
                    <div id="flashcard-maker">
                        <h3>ğŸƒ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© <button id="start-quiz-btn" class="success" style="display: inline-block; width: auto; float: left; padding: 8px 15px; font-size: 0.8em;" onclick="startQuiz()">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</button></h3>
                        <div id="flashcards-list"></div>
                        <h4>Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©:</h4>
                        <input type="text" id="flashcard-question-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§">
                        <textarea id="flashcard-answer-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¬ÙˆØ§Ø¨ Ù‡Ù†Ø§" rows="2"></textarea>
                        <button onclick="addFlashcard()">Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø©</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card" style="margin-top: 30px;">
            <h2>ğŸ“… Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© ÙØ§Ø¦Ù‚ Ø§Ù„Ø°ÙƒØ§Ø¡</h2>
            <p>ÙŠÙ‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ¢Ø®Ø± Ù…Ø±Ø© ØªÙ…Øª Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡Ø§.</p>
            <button onclick="generateSmartStudyPlan()" class="success" style="margin-top: 10px;">ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø© Ø°ÙƒÙŠØ©</button>
            <div id="study-plan-output" style="margin-top: 20px; background: #e9f5e9; padding: 15px; border-radius: 8px;"></div>
        </div>
    </div>

    <div id="quiz-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeQuiz()">&times;</span>
            <h3 id="quiz-subject-title">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</h3>
            <div id="quiz-card" onclick="revealAnswer()">
                <p id="quiz-question"></p>
                <p id="quiz-answer"></p>
            </div>
            <div class="quiz-controls">
                <button class="dont-know-btn" onclick="handleQuizResponse('Learning')">Ù„Ø§ Ø£Ø¹Ø±ÙÙ‡Ø§</button>
                <button class="know-btn" onclick="handleQuizResponse('Mastered')">Ø£Ø¹Ø±ÙÙ‡Ø§</button>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbysFcY5y2wkrk6fO7sRBn3iT0JQd4ElLzFNFh95CxUGpBNrNPNR-IjK5YJBFWjHD3SRXA/exec";

        let currentUserId, currentUsername, currentSubjectId, currentSubjectName;
        let subjectData = [], flashcardData = [];

        const loader = document.getElementById('loader');
        const showLoader = () => loader.style.display = 'block';
        const hideLoader = () => loader.style.display = 'none';

        async function callAppsScript(funcName, args = []) {
            showLoader();
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'cors', redirect: 'follow',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify({ action: funcName, params: args })
                });
                if (!res.ok) throw new Error(`Network error: ${res.status}`);
                const response = await res.json();
                if (response.status === 'error') throw new Error(response.message);
                return response.data;
            } catch (error) {
                alert(`Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}.`);
                return null;
            } finally {
                hideLoader();
            }
        }

        async function login() {
            const username = document.getElementById('username-input').value.trim();
            const password = document.getElementById('password-input').value;
            if (!username || !password) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.');
            const result = await callAppsScript('loginUser', [username, password]);
            if (result && result.userId) {
                currentUserId = result.userId;
                currentUsername = result.username;
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('app-section').style.display = 'block';
                document.getElementById('welcome-message').textContent = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ ${currentUsername}`;
                loadSubjects();
            }
        }

        function logout() {
            // Reset all state
            [currentUserId, currentUsername, currentSubjectId, currentSubjectName] = [null, null, null, null];
            [subjectData, flashcardData] = [[], []];
            document.getElementById('app-section').style.display = 'none';
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('username-input').value = '';
            document.getElementById('password-input').value = '';
            document.getElementById('subjects-list').innerHTML = '';
            document.getElementById('main-content').style.display = 'none';
        }

        async function loadSubjects() {
            if (!currentUserId) return;
            subjectData = await callAppsScript('getSubjects', [currentUserId]) || [];
            const list = document.getElementById('subjects-list');
            list.innerHTML = '';
            subjectData.forEach(s => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${s.name}</span> <span class="priority-dot priority-${s.priority}" title="Ø£ÙˆÙ„ÙˆÙŠØ© ${s.priority}"></span>`;
                li.dataset.id = s.id;
                li.onclick = () => selectSubject(s.id, s.name);
                list.appendChild(li);
            });
        }

        async function addSubject() {
            if (!currentUserId) return;
            const name = document.getElementById('subject-name-input').value.trim();
            const priority = document.getElementById('subject-priority-select').value;
            if (!name) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©.');
            const newSubject = await callAppsScript('addSubject', [currentUserId, name, priority]);
            if (newSubject) {
                document.getElementById('subject-name-input').value = '';
                await loadSubjects();
                selectSubject(newSubject.id, newSubject.name);
            }
        }

        function selectSubject(id, name) {
            currentSubjectId = id;
            currentSubjectName = name;
            document.getElementById('current-subject-title').textContent = `Ù…Ø­ØªÙˆÙ‰ Ù…Ø§Ø¯Ø©: ${name}`;
            document.getElementById('main-content').style.display = 'block';
            document.querySelectorAll('#subjects-list li').forEach(li => li.classList.toggle('active', li.dataset.id === id));
            loadFlashcards();
        }

        async function loadFlashcards() {
            if (!currentUserId || !currentSubjectId) return;
            flashcardData = await callAppsScript('getFlashcards', [currentUserId, currentSubjectId]) || [];
            const list = document.getElementById('flashcards-list');
            list.innerHTML = '';
            if (flashcardData.length > 0) {
                flashcardData.forEach(card => {
                    const div = document.createElement('div');
                    div.className = 'flashcard-item';
                    div.innerHTML = `<p><strong>Ø³:</strong> ${card.question}</p><p><strong>Ø¬:</strong> ${card.answer}</p>
                                     <span class="flashcard-status status-${card.status}">${card.status}</span>`;
                    list.appendChild(div);
                });
            } else {
                list.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø±Ø§Ø¬Ø¹Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ø¹Ø¯.</p>';
            }
        }

        async function addFlashcard() {
             if (!currentUserId || !currentSubjectId) return;
             const question = document.getElementById('flashcard-question-input').value.trim();
             const answer = document.getElementById('flashcard-answer-input').value.trim();
             if (!question || !answer) return;
             await callAppsScript('addFlashcard', [currentUserId, currentSubjectId, question, answer]);
             document.getElementById('flashcard-question-input').value = '';
             document.getElementById('flashcard-answer-input').value = '';
             loadFlashcards();
        }

        async function generateSmartStudyPlan() {
            if (subjectData.length === 0) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§Ø¯ Ø£ÙˆÙ„Ø§Ù‹.');
            
            const priorityValues = { 'High': 3, 'Medium': 2, 'Low': 1 };
            const now = new Date();

            const scoredSubjects = subjectData.map(s => {
                const daysSinceStudied = s.lastStudied ? (now - new Date(s.lastStudied)) / (1000 * 3600 * 24) : 999;
                // Score is a mix of priority and how long it's been since last studied
                const score = priorityValues[s.priority] * 2 + daysSinceStudied;
                return { ...s, score };
            }).sort((a, b) => b.score - a.score); // Sort by highest score

            const days = ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©"];
            let planHTML = '<h4>ğŸ—“ï¸ Ø®Ø·ØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:</h4><ul>';
            
            for (let i = 0; i < days.length; i++) {
                const subjectForToday = scoredSubjects[i % scoredSubjects.length];
                planHTML += `<li><strong>${days[i]}:</strong> Ù…Ø°Ø§ÙƒØ±Ø© Ù…Ø§Ø¯Ø© "${subjectForToday.name}"</li>`;
                // Update last studied date for this subject in the backend
                callAppsScript('updateLastStudied', [currentUserId, subjectForToday.id]);
            }
            planHTML += '</ul><p>ØªÙ… ØªØ­Ø¯ÙŠØ« ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©. Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚!</p>';
            document.getElementById('study-plan-output').innerHTML = planHTML;
            // Reload subjects to reflect new dates, but don't show loader
            setTimeout(loadSubjects, 1000);
        }

        // --- Smart Quiz Logic ---
        let quizFlashcards = [];
        let currentCardIndex = 0;

        function startQuiz() {
            if (flashcardData.length === 0) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.');
            // Prioritize 'New' and 'Learning' cards
            const learning = flashcardData.filter(c => c.status !== 'Mastered');
            const mastered = flashcardData.filter(c => c.status === 'Mastered');
            // Show all learning cards, then a few mastered cards for revision
            quizFlashcards = [...learning, ...mastered.slice(0, 3)].sort(() => Math.random() - 0.5);

            if (quizFlashcards.length === 0) return alert('Ø±Ø§Ø¦Ø¹! Ù„Ù‚Ø¯ Ø£ØªÙ‚Ù†Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª.');
            
            currentCardIndex = 0;
            document.getElementById('quiz-subject-title').innerText = `Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ Ù…Ø§Ø¯Ø©: ${currentSubjectName}`;
            document.getElementById('quiz-modal').style.display = 'block';
            displayQuizCard();
        }

        function closeQuiz() { 
            document.getElementById('quiz-modal').style.display = 'none';
            loadFlashcards(); // Refresh list to show updated statuses
        }

        function displayQuizCard() {
            const card = quizFlashcards[currentCardIndex];
            document.getElementById('quiz-question').innerText = card.question;
            document.getElementById('quiz-answer').innerText = card.answer;
            document.getElementById('quiz-question').style.display = 'block';
            document.getElementById('quiz-answer').style.display = 'none';
        }

        function revealAnswer() {
            document.getElementById('quiz-question').style.display = 'none';
            document.getElementById('quiz-answer').style.display = 'block';
        }

        async function handleQuizResponse(status) {
            const card = quizFlashcards[currentCardIndex];
            await callAppsScript('updateFlashcardStatus', [currentUserId, card.id, status]);
            
            currentCardIndex++;
            if (currentCardIndex >= quizFlashcards.length) {
                alert('Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø¬ÙˆÙ„Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©!');
                closeQuiz();
                return;
            }
            displayQuizCard();
        }

        window.onload = () => {
            document.getElementById('app-section').style.display = 'none';
            document.getElementById('login-section').style.display = 'block';
        };
    </script>
</body>
</html>
